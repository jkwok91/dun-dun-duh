{% extends "layout.html" %}

{% block head %}
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/0.9.12/css/jquery.Jcrop.min.css" type="text/css" />
{% endblock %}

{% block leader %}
<h1><strong>DUN, DUN, DUH!</strong></h1>
<div id="steps">
	<div id="step-1" class="active">1. Upload</div>
	<div id="step-2">2. Select</div>
	<div id="step-3">3. Zoom!</div>
</div>
{% endblock %}

{% block body %}
<div class="row" id="upload-row">
	<span class="btn btn-primary fileinput-button">
		<span>Select Image</span>
		<input type="file" name="file" id="file" />
	</span>
	<p id="upload-help" class="help-block">JPG/GIF/PNG - Max 6MB</p>
</div>

<div class="row" id="crop-row" style="display: none;">
	<p class="help-block">This is the final frame of your GIF, what we zoom in to.</p>
	<img src="" alt="Loading..." id="crop-image" />
	<div>
		<button class="btn btn-primary" id="make-the-gif-dude" disabled="disabled">Create My GIF &raquo;</button>
	</div>
</div>


<div class="row" id="progress-row" style="display: none;">
	<div id="progress" class="progress progress-striped active">
		<div class="progress-bar progress-bar-success" style="width: 100%"></div>
	</div>
	<p id="progress-text" class="help-block" style="text-align: center;">Uploading</p>
</div>

<div class="row" id="error-row" style="display: none;">
	<div id="error" class="alert alert-danger">
		<a href="{{ url_for("index") }}" class="pull-right btn btn-default btn-xs">Try again</a>
		<div class="pull-left"><strong>Well crap. It broke.</strong></div><br/>
		<span id="error-details">Something went wrong and your image was lost forever into the dark abyss.<br/>Sorry. Please don't be mad.</span><br/>
	</div>
</div>

{% endblock %}

{% block script %}
<script src="{{ url_for("static", filename="vendor/jQuery-File-Upload-9.5.2/js/vendor/jquery.ui.widget.js") }}"></script>
<script src="{{ url_for("static", filename="vendor/jQuery-File-Upload-9.5.2/js/jquery.iframe-transport.js") }}"></script>
<script src="{{ url_for("static", filename="vendor/jQuery-File-Upload-9.5.2/js/jquery.fileupload.js") }}"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/0.9.12/js/jquery.Jcrop.min.js"></script>
<script>
jQuery(function ($) {

	var working_messages = [
		"Uploading Pixels",
		"Grokking Polar Coordinates",
		"Reticulating Splines",
		"Adjusting Bell Curves",
		"Tweeting Your Home Address",
		"Googling For Jokes",
		"Blitting Image Maps",
		"Starting Photoshop",
		"Enhancing EXIF Data",
		"Licensing GIF89a",
		"Booting Gaussian Blur Kernel",
		"Blogging Haar Cascades"
	];

	var ddd = {},
	    upload = $('#file').fileupload({
				url: "{{ url_for("upload") }}",
				dataType: 'json',
				formData: {"upload_token": "{{ upload_token }}"},
				singleFileUploads: true,
				maxNumberOfFiles: 1,
				acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
				change: function (e, data) {
					var file = data.files[0];
					$('#upload-help').removeClass('error').text('');
					if (!(/\.(gif|jpe?g|png)$/i).test(file.name)) {
						$('#upload-help').addClass('error').text("Please select an image file. (jpg, gif, png)");
						return false;
					}
					else if (file.size > 6291456) {
						$('#upload-help').addClass('error').text("Please choose a smaller image. The largest acceptable size is 6MB.");
						return false;
					}
				},
				submit: function (e, data) {
					$("#upload-row").hide();
					$("#progress-row").show();
				},
				done: function (e, data) {
					if( data.result.error === false ) {
						$("#progress-text").text("Please Wait");
						ddd.id = data.result.files[0].id;
						$("#crop-image").attr("src", data.result.files[0].src);
					}
					else {
						$('#progress-row').hide();
						$('#error-details').text(data.result.error);
						$('#error-row').show();
					}
				},
				fail: function (e, data) {
					$('#upload-row').hide();
					$('#progress-row').hide();
					$('#error-row').show();
				},
				progressall: function (e, data) {
					var progress = parseInt(data.loaded / data.total * 100, 10);
					$('#progress .progress-bar').css('width', progress + '%');
					$("#progress-status").text(progress + "%");
				}
			});

	$('#crop-image')
		.on('load', function () {
			$("#progress-row").hide();
			$('#crop-row').show();

			$("#step-1").removeClass("active");
			$("#step-2").addClass("active");

			var $img = $(this),
					width = $img.width(),
					height = $img.height(),
					size, max_size, x, y;

			if( width < height ) {
				size = Math.max(10, Math.floor(width * 0.5));
				max_size = Math.max(10, Math.floor(width * 0.75));
			}
			else {
				size = Math.max(10, Math.floor(height * 0.5));
				max_size = Math.max(10, Math.floor(height * 0.75));
			}

			x = Math.floor((width - size) / 2);
			y = Math.floor((height - size) / 2);

			$(this).Jcrop({
				aspectRatio: 1,
				minSize: [10, 10],
				maxSize: [max_size, max_size],
				allowSelect: false,
				setSelect: [x, y, x + size, y + size],
				onSelect: function (c) {
					ddd.x = c.x;
					ddd.y = c.y;
					ddd.size = c.w;
					$("#make-the-gif-dude").attr('disabled', false);
				}
			});
		})
		.on('error', function () {
			$("#progress-row").hide();
			$('#error-row').show();
		});

		$("#make-the-gif-dude").on("click", function (e) {
			e.preventDefault();
			if( $(this).is(":disabled") ) { return; }

			$("#crop-row").hide();
			
			$(".progress-bar").css("width", "100%");
			$("#progress-text").text("");
			$("#progress-row").show();

			$("#step-2").removeClass("active");
			$("#step-3").addClass("active");

			updateCropProgressMessage();

			$.post("{{ url_for("compose") }}", ddd)
				.success(function (data) {
					ddd.job_id = data.job_id;
					checkJob();
				})
				.error(function (e) {
					$("#progress-row").hide();
					$("#error-row").show();
				});
		});

		function updateCropProgressMessage () {
			$('#progress-text').fadeOut('fast', function () {
				$(this).text(working_messages[Math.floor(Math.random() * working_messages.length)]);
				$(this).fadeIn('fast');
			});
		}

		var job_checks = 0;

		function checkJob () {
			updateCropProgressMessage();
			$.getJSON(
				"{{ url_for("rq_job_status") }}",
				{id: ddd.job_id}
			)
			.success(function (data) {
				if( data.error ) {
					$('#progress-row').hide();
					$('#error-row').show();
				}
				else {
					if( data.data.failed ) {
						$('#progress-row').hide();
						$('#error-row').show();
					}
					else if( data.data.finished ) {
						window.location.href = data.data.return_value.view_url;
					}
					else {
						if( ++job_checks > 8 ) {
							$('#progress-row').hide();
							$('#error-row').show();
						}
						else {
							setTimeout(checkJob, 1000);
						}
					}
				}
			})
			.error(function (e) {
				$('#progress-row').hide();
				$('#error-row').show();
			});
		}

});
</script>
{% endblock %}
